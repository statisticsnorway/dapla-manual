---
title: "SSB Guardian Client: Maskinporten-autentisering i Dapla"
author: "Dapla Team"
date: "12/04/2025"
format: html
categories: [Dapla, Python, Autentisering, Maskinporten]
---

## Innledning

I dette blogginnlegget introduserer vi `ssb-guardian-client`, en Python-pakke som forenkler bruk av Maskinporten-autentisering n√•r du skal kalle eksterne API-er fra Dapla-plattformen. Pakken h√•ndterer automatisk tokenadministrasjon via Guardian-tjenesten og gj√∏r det enkelt √• integrere med eksterne tjenester som krever Maskinporten-autentisering.

## Hva er SSB Guardian Client?

`ssb-guardian-client` er et klientbibliotek som integrerer med Guardian-tjenesten for √• hente Maskinporten-tokens og kalle eksterne API-er. Den abstrahere bort kompleksiteten i OAuth2-flyten og gir et enkelt grensesnitt for utviklere.

### Hovedfunksjoner

- **Maskinporten-integrasjon**: S√∏ml√∏s integrasjon med Maskinporten for sikker API-autentisering
- **Guardian Token Management**: Automatisk henting og administrasjon av Maskinporten-tokens via Guardian
- **Multi-milj√∏st√∏tte**: Fungerer p√• tvers av DEV, TEST og PROD i Dapla-plattformen
- **Enkelt API**: Lett √• bruke klientgrensesnitt for eksterne API-kall
- **Automatisk token-h√•ndtering**: Henter personlige tokens automatisk via `dapla-auth-client`

## Installasjon

Du kan installere `ssb-guardian-client` via pip fra PyPI:

```bash
pip install ssb-guardian-client
```

Eller med Poetry:

```bash
poetry add ssb-guardian-client
```

## Krav

For √• bruke `ssb-guardian-client` trenger du:

- Python 3.10 eller h√∏yere
- Tilgang til Statistisk sentralbyr√•s Dapla-plattform
- Gyldige Maskinporten-klientopplysninger
- `DAPLA_ENVIRONMENT`-milj√∏variabel satt til enten `DEV`, `TEST` eller `PROD`

## Grunnleggende bruk

### Hurtigstart

Den enkleste m√•ten √• kalle et eksternt API med Maskinporten-autentisering:

```python
from ssb_guardian_client import GuardianClient

# Opprett en GuardianClient-instans
client = GuardianClient()

# Kall et eksternt API med Maskinporten-autentisering
response = client.call_api(
    api_endpoint_url="https://api.example.com/data",
    maskinporten_client_id="your-maskinporten-client-id",
    scopes="scope1 scope2",  # Mellomromseparert streng
)

# Responsen inneholder JSON-data fra API-et
print(response)
```

Metoden `call_api` gj√∏r automatisk f√∏lgende:

1. Henter ditt personlige Keycloak-token via `dapla-auth-client`
2. Ber om Maskinporten-token fra Guardian
3. Kaller m√•l-API-et med Maskinporten-tokenet
4. Returnerer JSON-responsen

### Hente Maskinporten-tokens direkte

Hvis du trenger mer kontroll eller bare vil hente Maskinporten-tokenet:

```python
from ssb_guardian_client import GuardianClient

# Opprett en GuardianClient-instans
client = GuardianClient()

# Hent et Maskinporten-token for tilpasset bruk
# Scopes kan sendes som enten en liste eller mellomromseparert streng
maskinporten_token = client.get_maskinporten_token(
    maskinporten_client_id="your-client-id",
    scopes=["scope1", "scope2"]  # Liste av scopes
)

# Eller med mellomromseparert streng:
maskinporten_token = client.get_maskinporten_token(
    maskinporten_client_id="your-client-id",
    scopes="scope1 scope2"  # Mellomromseparert streng
)

# Bruk tokenet for tilpassede API-kall
import requests
response = requests.get(
    "https://api.example.com/data",
    headers={"Authorization": f"Bearer {maskinporten_token}"}
)
```

**üìù Merk: Scopes-format**

Parameteren `scopes` aksepterer begge formater:

- ‚úÖ Liste: `["scope1", "scope2"]` eller `["elhub:publicstakeholder"]`
- ‚úÖ Streng: `"scope1 scope2"` eller `"elhub:publicstakeholder"`

## Milj√∏konfigurasjon

Klienten oppdager automatisk Dapla-milj√∏et fra `DAPLA_ENVIRONMENT`-milj√∏variabelen og bruker riktig Guardian-URL:

- **DEV/TEST**: `https://guardian.intern.test.ssb.no/maskinporten/access-token`
- **PROD**: `https://guardian.intern.ssb.no/maskinporten/access-token`

S√∏rg for at `DAPLA_ENVIRONMENT`-variabelen er satt til √©n av: `DEV`, `TEST` eller `PROD`. I Dapla-notebooks er dette vanligvis allerede satt.

## Komplett eksempel

Her er et komplett eksempel som viser typisk bruk:

```python
import os
from ssb_guardian_client import GuardianClient

# S√∏rg for at milj√∏et er satt (vanligvis allerede satt i Dapla-notebooks)
# os.environ["DAPLA_ENVIRONMENT"] = "TEST"

# Opprett en GuardianClient-instans
client = GuardianClient()

# Kall et eksternt API
try:
    response = client.call_api(
        api_endpoint_url="https://api.external-service.no/v1/data",
        maskinporten_client_id="my-maskinporten-client",
        scopes="nav:some/scope nav:another/scope",  # Mellomromseparert streng
    )

    # Behandle responsen
    for item in response.get("data", []):
        print(f"Mottatt data: {item}")

except RuntimeError as e:
    print(f"API-kall feilet: {e}")
```

## Brukseksempler fra virkeligheten

### Eksempel 1: Hente data fra Elhub

```python
from ssb_guardian_client import GuardianClient

client = GuardianClient()

# Hent data fra Elhub API
elhub_data = client.call_api(
    api_endpoint_url="https://api.elhub.no/metering-values/api/v1/measurements",
    maskinporten_client_id="elhub-client-id",
    scopes="elhub:publicstakeholder",
)

# Prosesser dataene
for measurement in elhub_data.get("measurements", []):
    print(f"M√•ling: {measurement}")
```

### Eksempel 2: Integrere med NAV-API

```python
from ssb_guardian_client import GuardianClient

client = GuardianClient()

# Hent arbeidsmarkedsdata fra NAV
nav_data = client.call_api(
    api_endpoint_url="https://api.nav.no/arbeid/v1/statistikk",
    maskinporten_client_id="nav-client-id",
    scopes="nav:arbeid/statistikk.read",
)

print(f"Hentet {len(nav_data)} poster fra NAV")
```

### Eksempel 3: Bruke token for flere kall

```python
from ssb_guardian_client import GuardianClient
import requests

client = GuardianClient()

# Hent token √©n gang
token = client.get_maskinporten_token(
    maskinporten_client_id="my-client-id",
    scopes=["scope1", "scope2"]
)

# Bruk tokenet for flere API-kall
headers = {"Authorization": f"Bearer {token}"}

response1 = requests.get("https://api.example.com/endpoint1", headers=headers)
response2 = requests.get("https://api.example.com/endpoint2", headers=headers)
response3 = requests.get("https://api.example.com/endpoint3", headers=headers)
```

## Feils√∏king

### Vanlige problemer

**ValueError: Unknown environment**

- S√∏rg for at `DAPLA_ENVIRONMENT`-milj√∏variabelen er satt til √©n av: `DEV`, `TEST` eller `PROD`

```python
import os
os.environ["DAPLA_ENVIRONMENT"] = "TEST"
```

**RuntimeError: Error getting maskinporten access-token from guardian**

- Verifiser at Maskinporten-klient-ID og scopes er korrekte
- S√∏rg for at du har n√∏dvendige tillatelser til √• bruke den spesifiserte Maskinporten-klienten
- Sjekk at ditt Keycloak-token er gyldig

**RuntimeError: Error calling target API**

- Verifiser at API-endepunkt-URL-en er korrekt
- S√∏rg for at Maskinporten-scopes matcher det API-et krever
- Sjekk at API-et er tilgjengelig fra ditt milj√∏

## API-oversikt

### GuardianClient

Hovedklassen for √• interagere med Guardian-tjenesten.

**Initialisering:**
```python
client = GuardianClient()
```

**Metoder:**

- `call_api(api_endpoint_url, maskinporten_client_id, scopes)` - Kaller et eksternt API med Maskinporten-autentisering
- `get_maskinporten_token(maskinporten_client_id, scopes)` - Henter kun Maskinporten-tokenet for tilpasset bruk

## Sikkerhet og beste praksis

1. **Ikke hardkod credentials**: Bruk milj√∏variabler eller sikre konfigurasjonsfiler
2. **Valider scopes**: S√∏rg for at du bare ber om scopes du faktisk trenger
3. **H√•ndter tokens forsiktig**: Tokens er sensitive og skal ikke logges eller eksponeres
4. **Bruk HTTPS**: Alle API-kall skal bruke HTTPS for sikker kommunikasjon

## Ressurser

- **Dokumentasjon**: [https://statisticsnorway.github.io/ssb-guardian-client](https://statisticsnorway.github.io/ssb-guardian-client)
- **Kildekode**: [https://github.com/statisticsnorway/ssb-guardian-client](https://github.com/statisticsnorway/ssb-guardian-client)
- **PyPI**: [https://pypi.org/project/ssb-guardian-client/](https://pypi.org/project/ssb-guardian-client/)
- **Rapporter problemer**: [GitHub Issues](https://github.com/statisticsnorway/ssb-guardian-client/issues)

## Oppsummering

`ssb-guardian-client` gj√∏r det enkelt √•:

- Integrere med eksterne API-er som krever Maskinporten-autentisering
- H√•ndtere OAuth2-flyten automatisk via Guardian
- Jobbe p√• tvers av DEV, TEST og PROD-milj√∏er
- Fokusere p√• forretningslogikk i stedet for autentisering

Med `ssb-guardian-client` kan du enkelt og sikkert kalle eksterne API-er fra Dapla-plattformen!
